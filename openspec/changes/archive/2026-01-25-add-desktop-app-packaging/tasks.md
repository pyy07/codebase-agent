# Tasks: 桌面应用打包功能实现任务

## 阶段 1: Electron 基础集成（2-3天）

### Task 1.1: 安装和配置 Electron 依赖
- [x] 在 `web/package.json` 中添加 Electron 相关依赖
  - `electron` (开发依赖)
  - `electron-builder` (开发依赖)
  - `concurrently` (开发依赖)
  - `wait-on` (开发依赖)
- [x] 更新 `package.json` scripts，添加桌面应用相关命令
- [x] 验证依赖安装成功

**验收标准**：
- 所有依赖正确安装
- package.json 中新增 `electron:dev`, `electron:build` 等脚本

### Task 1.2: 创建 Electron 主进程文件
- [x] 创建 `web/electron/` 目录
- [x] 创建 `web/electron/main.js` - Electron 主进程
  - 实现窗口创建和管理
  - 实现应用生命周期处理
  - 集成后端进程管理器
- [x] 创建 `web/electron/preload.js` - 预加载脚本
  - 实现安全的上下文桥接
  - 暴露必要的 API 给前端
- [x] 创建 `web/electron/backend.js` - 后端进程管理器
  - 实现 Python 环境检测
  - 实现后端进程启动和停止
  - 实现健康检查

**验收标准**：
- Electron 应用可以启动
- 窗口正常显示
- 后端进程可以自动启动

### Task 1.3: 配置开发环境
- [x] 更新 `web/package.json` 添加开发脚本
  - `electron:dev` - 开发模式启动（同时启动前端和后端）
- [x] 配置 Vite 构建，确保生产构建输出正确
- [x] 测试开发模式下的热重载

**验收标准**：
- 运行 `npm run electron:dev` 可以启动桌面应用
- 前端代码修改可以热重载
- 后端代码修改需要重启应用

## 阶段 2: 后端进程管理（2-3天）

### Task 2.1: 实现 Python 环境检测
- [x] 在 `backend.js` 中实现 `detectPython()` 方法
  - Windows: 检测 `python.exe` 或 `python3.exe`
  - macOS/Linux: 检测 `python3`
  - 支持通过环境变量指定 Python 路径
- [x] 实现 Python 版本检查（需要 >= 3.11）
- [x] 实现友好的错误提示（如果 Python 未安装）

**验收标准**：
- 可以正确检测系统 Python
- Python 版本不符合要求时显示错误提示
- 支持自定义 Python 路径

### Task 2.2: 实现后端进程启动和管理
- [x] 实现 `BackendManager.start()` 方法
  - 检查后端是否已运行（避免重复启动）
  - 启动 Python 后端进程
  - 等待后端服务就绪（轮询 `/health` 端点）
- [x] 实现 `BackendManager.stop()` 方法
  - 优雅关闭后端进程
  - 清理资源
- [x] 实现后端进程异常处理
  - 监听进程错误事件
  - 实现自动重启机制（可选）
  - 记录错误日志

**验收标准**：
- 后端进程可以正常启动
- 后端进程可以正常停止
- 后端进程崩溃时可以检测并处理

### Task 2.3: 实现后端日志输出
- [x] 在 Electron 主进程中捕获后端进程的 stdout/stderr
- [x] 实现日志输出到控制台（开发模式）
- [x] 实现日志输出到文件（生产模式，可选）
- [x] 实现日志级别过滤

**验收标准**：
- 后端日志可以在 Electron 控制台查看
- 日志格式清晰易读
- 错误日志可以正确捕获

## 阶段 3: 前端集成和配置（1-2天）

### Task 3.1: 调整前端配置
- [x] 检查前端代码，确保在桌面环境下正常工作
- [x] 调整 API 端点配置（桌面环境使用 `http://localhost:8000`）
- [x] 测试 SSE 流式通信在桌面环境下是否正常
- [x] 处理跨域问题（如果需要）

**验收标准**：
- 前端可以正常连接后端 API
- SSE 流式通信正常工作
- 所有功能在桌面环境下正常

### Task 3.2: 添加桌面应用特定功能（可选）
- [ ] 检测运行环境（Web vs Desktop）
- [ ] 添加桌面应用特定的 UI 元素（如窗口控制）
- [ ] 实现应用内配置界面（替代环境变量）
- [ ] 实现数据持久化（使用 Electron 的存储 API）

**验收标准**：
- 可以区分运行环境
- 桌面应用特定功能正常工作

## 阶段 4: 打包配置（2-3天）

### Task 4.1: 配置 electron-builder
- [x] 在 `web/package.json` 中添加 `build` 配置
  - 配置应用 ID、名称、版本
  - 配置 Windows 打包（NSIS）
  - 配置 macOS 打包（DMG）
  - 配置 Linux 打包（AppImage）
- [x] 创建应用图标资源
  - Windows: `.ico` 文件
  - macOS: `.icns` 文件
  - Linux: `.png` 文件
- [x] 配置打包文件包含规则
  - 包含前端构建产物
  - 包含后端 Python 代码
  - 包含必要的配置文件

**验收标准**：
- electron-builder 配置正确
- 应用图标正确显示
- 打包文件大小合理

### Task 4.2: 实现 Python 后端打包策略
- [x] 研究 Python 后端打包方案
  - 方案 A: 依赖系统 Python（先实现）
  - 方案 B: 打包 Python 运行时（后续扩展）
- [x] 实现方案 A：检测系统 Python
  - 在应用启动时检测
  - 如果没有则提示用户安装
  - 提供 Python 下载链接
- [x] 创建打包脚本
  - `scripts/build-desktop.sh` - 构建桌面应用
  - 自动化构建流程

**验收标准**：
- 打包后的应用可以检测系统 Python
- Python 未安装时显示友好提示
- 打包脚本可以一键构建

### Task 4.3: 测试多平台打包
- [ ] 测试 Windows 平台打包
  - 生成 NSIS 安装程序
  - 测试安装和卸载
  - 测试应用启动和运行
- [ ] 测试 macOS 平台打包
  - 生成 DMG 磁盘镜像
  - 测试应用签名（如果需要）
  - 测试应用启动和运行
- [ ] 测试 Linux 平台打包
  - 生成 AppImage 文件
  - 测试应用启动和运行
  - 测试文件权限

**验收标准**：
- 所有平台都可以成功打包
- 打包后的应用可以正常安装和运行
- 应用功能完整

## 阶段 5: 文档和优化（1-2天）

### Task 5.1: 更新文档
- [x] 更新 `README.md`
  - 添加桌面应用构建说明
  - 添加桌面应用使用说明
- [x] 创建 `docs/DESKTOP_APP.md`
  - 详细的桌面应用开发指南
  - 打包和分发指南
  - 故障排除指南
- [x] 更新 `.gitignore`
  - 添加桌面应用构建产物忽略规则

**验收标准**：
- 文档完整清晰
- 用户可以按照文档构建桌面应用

### Task 5.2: 优化和测试
- [ ] 性能优化
  - 优化应用启动时间
  - 优化内存使用
  - 优化打包体积
- [ ] 错误处理完善
  - 添加更多错误场景处理
  - 改进错误提示信息
- [ ] 端到端测试
  - 测试完整的使用流程
  - 测试异常场景
  - 测试多平台兼容性

**验收标准**：
- 应用启动时间 < 5 秒
- 内存使用合理
- 所有测试通过

## 依赖关系

```
Task 1.1 → Task 1.2 → Task 1.3
                ↓
Task 2.1 → Task 2.2 → Task 2.3
                ↓
Task 3.1 → Task 3.2
                ↓
Task 4.1 → Task 4.2 → Task 4.3
                ↓
Task 5.1 → Task 5.2
```

## 并行任务

- Task 1.1, 2.1, 3.1 可以并行进行（不同模块）
- Task 4.1, 4.2 可以并行进行（不同打包策略）
- Task 5.1 可以在 Task 4.3 完成后开始

## 风险点

1. **Python 环境检测**：不同系统的 Python 安装位置可能不同
   - 缓解：提供详细的错误提示和安装指南

2. **后端进程管理**：进程启动失败或崩溃处理
   - 缓解：实现完善的错误处理和自动重启机制

3. **打包体积**：包含 Python 运行时会导致体积较大
   - 缓解：先实现依赖系统 Python 的方案，后续可优化

4. **跨平台兼容性**：不同平台的差异可能导致问题
   - 缓解：在每个平台进行充分测试
